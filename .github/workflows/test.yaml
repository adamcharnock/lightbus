name: test

on:
  push:
    paths:
      - '.github/workflows/test.yaml'
      - 'lightbus/**'
      - 'tests/**'
      - 'poetry.lock'
      - 'pyproject.toml'
      - 'pytest.ini'
      - 'lightbus_vendored/**'

jobs:
  test:
    name: Test
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        python:
#          - '3.8'
#          - '3.9'
#          - '3.10'
          - '3.11'

    services:
      redis:
        image: redis:5
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@master

      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python }}

      - name: Install
        run: |
          pip install poetry
          poetry config virtualenvs.in-project true
          poetry install
          mkdir -p .coverage .test-reports

      - name: Test
        run: |
          poetry run pytest --cov=lightbus --junit-xml=junit.xml -v -m "not benchmark" --maxfail=10
          mv .coverage/coverage .coverage/coverage-${{ github.run_number }}

      - name: Upload code coverage report
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage-reports
          path: .coverage/*

  code_coverage:
    name: Code Coverage Reports
    runs-on: ubuntu-22.04
    needs: test

    steps:
      - uses: actions/setup-python@v2
        with:
          python-version: 3.11

      - name: Download coverage reports
        uses: actions/download-artifact@v3
        with:
          name: code-coverage-reports

      - name: Send coverage reports
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          api-token: ${{ secrets.CODACY_API_TOKEN }}
          coverage-reports: code-coverage-reports/*
